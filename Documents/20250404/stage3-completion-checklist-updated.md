# 단계 3: 시간 동기화 기본 기능 구현 - 체크리스트

## 모듈 3: 기본 PTP 구현
- [x] PTP 메시지 구조 정의
  - [x] FPTPMessageHeader 구조체 구현
  - [x] FPTPTimestamp 구조체 구현
  - [x] 메시지 타입별 구조체 구현 (Sync, DelayReq, FollowUp, DelayResp)
  - [x] 메시지 타입 열거형 정의 (EPTPMessageType)
- [x] 기본 타임스탬핑 기능
  - [x] 마이크로초 단위 정밀 타임스탬프 생성 함수 구현
  - [x] 타임스탬프 변환 함수 구현 (마이크로초 <-> 초/나노초)
  - [x] 메시지 생성 시 타임스탬프 포함 로직 구현
- [x] 간단한 마스터-슬레이브 시간 동기화
  - [x] Sync 메시지 처리 로직 구현
    - [x] 마스터 모드에서 주기적 Sync 메시지 전송
    - [x] 슬레이브 모드에서 Sync 메시지 수신 및 T2 저장
  - [x] Follow-Up 메시지 처리 로직 구현
    - [x] 마스터 모드에서 정확한 타임스탬프 전송
    - [x] 슬레이브 모드에서 수신 및 T1 추출
  - [x] DelayReq/DelayResp 메시지 처리 로직 구현
    - [x] 슬레이브 모드에서 DelayReq 메시지 전송 및 T3 저장
    - [x] 마스터 모드에서 DelayReq 수신 및 DelayResp 응답
    - [x] 슬레이브 모드에서 DelayResp 수신 및 T4 추출
  - [x] 시간 오프셋 계산 로직
    - [x] 마스터-슬레이브 시간차 계산
    - [x] 경로 지연 계산 및 보정
    - [x] 오프셋 필터링 및 안정화 메커니즘

## 모듈 4: 기본 소프트웨어 PLL
- [x] 간단한 PLL 알고리즘 구현
  - [x] 위상 비교기 (Phase Detector) 구현
  - [x] 루프 필터 (Loop Filter) 구현
  - [x] 전압 제어 발진기 (VCO) 구현
  - [x] PLL 상태 관리 및 업데이트 로직
- [x] 기본 필터링 메커니즘
  - [x] 이동 평균 필터 구현
  - [x] 지수 가중 이동 평균 필터 구현
  - [x] 이상치 (Outlier) 감지 및 제거 로직
- [x] 로컬 클록 조정 기본 기능
  - [x] 주파수 조정 메커니즘
  - [x] 위상 조정 메커니즘
  - [x] 조정값 적용 및 안정화 로직

## 모듈 5: 기본 프레임 동기화
- [ ] 언리얼 엔진 틱(Tick) 후킹
  - [ ] 엔진 틱 델리게이트 연결
  - [ ] 틱 이벤트 처리 함수 구현
  - [ ] 렌더링 파이프라인 이벤트 후킹
- [ ] 프레임 카운터 구현
  - [ ] 동기화된 프레임 카운터 관리
  - [ ] 프레임 번호 네트워크 동기화
  - [ ] 프레임 번호 불일치 감지 및 수정
- [ ] 기본 프레임 타이밍 조정 메커니즘
  - [ ] 프레임 지연/가속 로직 구현
  - [ ] 타겟 프레임 레이트 제어 기능
  - [ ] 프레임 타이밍 조정값 계산

## 모듈 간 통합
- [x] FTimeSync와 FPTPClient 통합
  - [x] FTimeSync에서 PTP 클라이언트 관리
  - [x] 네트워크 메시지 처리 및 전달
  - [x] 동기화 상태 및 오프셋 관리
- [x] FTimeSync와 FSoftwarePLL 통합
  - [x] PTP 측정값을 PLL에 전달
  - [x] PLL 출력을 시간 조정에 적용
  - [x] 상태 모니터링 및 진단 로직
- [ ] 네트워크 매니저 연동
  - [x] 시간 동기화 메시지 전송 함수 추가
  - [x] 시간 동기화 메시지 수신 처리 로직 추가
  - [ ] 프레임워크 매니저를 통한 모듈 간 참조 설정

## 단계 3 테스트 및 검증
- [ ] 기본 시간 동기화 정확도 측정
  - [ ] 타임스탬프 정확도 검증
  - [ ] 마스터-슬레이브 간 시간 오프셋 측정
  - [ ] 경로 지연 측정 및 안정성 검증
- [ ] 두 인스턴스 간 시간 차이 시각화
  - [ ] 시간 오프셋 로깅 및 그래프 생성
  - [ ] 동기화 진행 상황 시각화
  - [ ] 오류 상황 감지 및 보고
- [ ] 프레임 타이밍 로깅 및 분석
  - [ ] 프레임 간격 측정 및 로깅
  - [ ] 프레임 지터 분석
  - [ ] 프레임 동기화 정확도 측정
- [ ] 전체 시스템 기본 기능 통합 테스트
  - [ ] 마스터-슬레이브 전환 테스트
  - [ ] 다양한 네트워크 조건에서의 동작 테스트
  - [ ] 장시간 안정성 테스트

## 해결된 주요 기술적 과제
- [x] 정밀한 시간 측정 및 동기화 구현
- [x] PTP 메시지 구조화 및 직렬화/역직렬화
- [x] 마스터-슬레이브 모드 전환 기능
- [x] 경로 지연 측정 및 보정 알고리즘
- [x] 시간 오프셋 계산 및 적용 메커니즘
- [x] PLL 알고리즘 구현 및 통합
- [x] 지수 가중 이동 평균 필터 구현
- [x] 주파수 및 위상 조정 메커니즘
- [x] 안정화 상태(락 상태) 감지 및 보고

## 소프트웨어 PLL 구현 세부 사항
소프트웨어 PLL은 다음 주요 구성 요소로 구현되었습니다:

1. **위상 비교기 (Phase Detector)**
   - `UpdateWithMeasurement` 함수에서 시간 오프셋 값을 입력으로 받아 처리
   - 현재 시간과 마스터 시간의 차이를 측정하여 오프셋 계산

2. **루프 필터 (Loop Filter)**
   - `ApplyFilter` 함수에서 지수 가중 이동 평균 필터 구현
   - `CalculateFrequencyAdjustment` 함수에서 PI(비례-적분) 제어 알고리즘 구현
   - 비례 게인(P_Gain)과 적분 게인(I_Gain)을 사용하여 조정값 계산
   - 이상치 감지 및 필터링

3. **전압 제어 발진기 (VCO)**
   - `CalculateFrequencyAdjustment`와 `CalculatePhaseAdjustment` 함수를 통해 구현
   - 주파수 조정: 클록 속도를 미세하게 조정
   - 위상 조정: 시간 오프셋을 직접 조정

4. **락 상태 관리**
   - `UpdateLockState` 함수에서 안정적인 동기화 상태 감지
   - 연속적으로 안정적인 측정값이 유지될 때 락 상태로 전환
   - 락 상태 유지 및 손실 모니터링

이 구현을 통해 네트워크 지연이나 지터가 있는 환경에서도 안정적인 시간 동기화가 가능합니다. FTimeSync 클래스와의 통합으로 PTP 프로토콜에서 측정된 시간 오프셋을 정밀하게 필터링하고 안정화시킵니다.
